<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéØ YOLO Mobile - Notes</title>
    <style>
        /* RESET MOBILE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            overscroll-behavior: none;
            touch-action: pan-x pan-y;
            height: 100vh;
            overflow: hidden;
        }
        
        /* CONTAINER PRINCIPAL */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        /* HEADER MOBILE */
        .mobile-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(90deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* CAM√âRA MOBILE */
        .camera-section {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        
        .camera-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        /* HUD MOBILE */
        .hud {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }
        
        .hud-item {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .live-indicator {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .live-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        .stats-indicator {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        
        /* FPS COUNTER */
        .fps-counter {
            position: absolute;
            bottom: 80px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 10;
        }
        
        /* INFO BULLE */
        .info-bubble {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            text-align: center;
            max-width: 90%;
            z-index: 20;
            border: 1px solid rgba(0, 255, 136, 0.3);
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.1);
        }
        
        /* CONTR√îLES MOBILE */
        .mobile-controls {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .mobile-btn {
            flex: 1;
            background: rgba(59, 130, 246, 0.9);
            border: none;
            color: white;
            padding: 15px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .mobile-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        .mobile-btn.active {
            background: rgba(0, 255, 136, 0.9);
            color: #000;
        }
        
        .mobile-btn.danger {
            background: rgba(239, 68, 68, 0.9);
        }
        
        /* PANEL D√âTECTIONS (Drawer) */
        .detections-drawer {
            position: fixed;
            bottom: -80%;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 30px 30px 0 0;
            padding: 20px 15px;
            z-index: 1000;
            transition: bottom 0.3s ease;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .detections-drawer.open {
            bottom: 0;
        }
        
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .drawer-title {
            font-size: 18px;
            font-weight: 600;
            color: #00ff88;
        }
        
        .detections-count {
            background: #00ff88;
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
        }
        
        /* LISTE D√âTECTIONS */
        .detections-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .detection-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            border-left: 4px solid #00ff88;
        }
        
        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .detection-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .detection-confidence {
            background: #00ff88;
            color: #000;
            padding: 2px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 12px;
        }
        
        .detection-details {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* LOADER MOBILE */
        .mobile-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            z-index: 50;
        }
        
        .mobile-loader.active {
            display: block;
        }
        
        .loader-circle {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s linear infinite;
        }
        
        /* TOAST NOTIFICATIONS */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 14px;
            z-index: 2000;
            transition: transform 0.3s ease;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* ANIMATIONS */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* RESPONSIVE */
        @media (max-width: 480px) {
            .mobile-btn {
                padding: 12px;
                font-size: 14px;
            }
            
            .detections-drawer {
                padding: 15px 10px;
            }
        }
        
        /* SAFE AREAS */
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="mobile-header safe-area-top">
            <div class="header-content">
                <div class="app-title">üéØ YOLO Mobile</div>
                <div class="hud-item stats-indicator">
                    <span>üìä</span>
                    <span id="stats-display">0 d√©tections</span>
                </div>
                  <button class="camera-toggle-btn" id="btn-camera" onclick="toggleCamera()">
            üì∑
        </button>
            </div>
        </div>
        
        <!-- CAM√âRA -->
        <div class="camera-section">
            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="overlay"></canvas>
                
                <!-- HUD -->
                <div class="hud">
                    <div class="hud-item live-indicator">
                        <div class="live-dot"></div>
                        <span>EN DIRECT</span>
                    </div>
                </div>
                
                <!-- INFO -->
                <div class="info-bubble" id="info-bubble">
                    üéØ Pr√™t √† d√©tecter
                </div>
                
                <!-- FPS -->
                <div class="fps-counter">
                    FPS: <span id="fps-display">0</span>
                </div>
                
                <!-- LOADER -->
                <div class="mobile-loader" id="loader">
                    <div class="loader-circle"></div>
                </div>
            </div>
        </div>
        
        <!-- CONTR√îLES -->
        <div class="mobile-controls safe-area-bottom">
            <button class="mobile-btn" id="btn-start" onclick="startDetection()">
                ‚ñ∂Ô∏è D√©marrer
            </button>
            <button class="mobile-btn danger" id="btn-stop" onclick="stopDetection()" disabled>
                ‚èπÔ∏è Arr√™ter
            </button>
            <button class="mobile-btn" id="btn-toggle-drawer" onclick="toggleDrawer()">
                üìã Liste
            </button>
        </div>
        
        <!-- DRAWER D√âTECTIONS -->
        <div class="detections-drawer" id="detectionsDrawer">
            <div class="drawer-header">
                <div class="drawer-title">üìã D√©tections actives</div>
                <div class="detections-count" id="detectionsCount">0</div>
            </div>
            <div class="detections-list" id="detectionsList">
                <!-- Les d√©tections seront ajout√©es ici -->
            </div>
        </div>
        
        <!-- TOAST -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION MOBILE
        // ============================================
        const API_URL = "https://thi-creasy-lightsomely.ngrok-free.dev";
        const MOBILE_CONFIG = {
            detectionInterval: 1000, // 1 seconde
            minConfidence: 50, // 50% minimum
            maxBoxWidth: 0.9, // 90% de l'√©cran max
            maxBoxHeight: 0.9
        };
        
        // ============================================
        // √âL√âMENTS DOM MOBILE
        // ============================================
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const ctx = overlay.getContext('2d');
        const infoBubble = document.getElementById('info-bubble');
        const detectionsList = document.getElementById('detectionsList');
        const detectionsCount = document.getElementById('detectionsCount');
        const fpsDisplay = document.getElementById('fps-display');
        const statsDisplay = document.getElementById('stats-display');
        const loader = document.getElementById('loader');
        const toast = document.getElementById('toast');
        const detectionsDrawer = document.getElementById('detectionsDrawer');
        
        // Boutons
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        
        // ============================================
        // VARIABLES MOBILE
        // ============================================
        let isStreaming = false;
        let isProcessing = false;
        let detectionActive = false;
        let detectionInterval = null;
        let currentDetections = [];
        let frameCount = 0;
        let lastFpsTime = Date.now();
        let fps = 0;
        let lastToastTime = 0;
        
        // ============================================
        // INITIALISATION MOBILE
        // ============================================
        async function initializeMobile() {
            showToast("üì± Initialisation...");
            
            try {
                // 1. Test API
                const apiHealthy = await testMobileAPI();
                if (!apiHealthy) {
                    showToast("‚ùå API non disponible", true);
                    return;
                }
                
                // 2. Cam√©ra mobile
                const cameraReady = await initializeMobileCamera();
                if (!cameraReady) {
                    showToast("üì∑ Utilisation mode d√©mo");
                    setupDemoMode();
                }
                
                // 3. Interface
                updateInfoBubble("‚úÖ Pr√™t √† d√©tecter");
                showToast("‚úÖ Syst√®me pr√™t");
                
                // D√©marrer auto apr√®s 2s
                setTimeout(() => {
                    if (isStreaming) {
                        startDetection();
                    }
                }, 2000);
                
            } catch (error) {
                console.error("Init error:", error);
                showToast("‚ùå Erreur initialisation", true);
            }
        }
        
        // ============================================
        // CAM√âRA MOBILE
        // ============================================
        async function initializeMobileCamera() {
            try {
                // Pr√©f√©rences mobile
                const constraints = {
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 60 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        overlay.width = video.videoWidth;
                        overlay.height = video.videoHeight;
                        isStreaming = true;
                        
                        // Ajuster pour mobile
                        const aspect = video.videoWidth / video.videoHeight;
                        console.log(`üì± Cam√©ra: ${video.videoWidth}x${video.videoHeight} (${aspect.toFixed(2)})`);
                        
                        resolve(true);
                    };
                    
                    video.onerror = () => resolve(false);
                });
                
            } catch (error) {
                console.warn("Cam√©ra mobile error:", error);
                return false;
            }
        }
        
        // ============================================
        // API MOBILE
        // ============================================
        async function testMobileAPI() {
            try {
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                
                const data = await response.json();
                console.log("üì° API mobile:", data);
                
                if (data.mobile) {
                    showToast(`‚úÖ API Mobile v${data.version}`);
                }
                
                return data.status === "online";
                
            } catch (error) {
                console.error("API test error:", error);
                return false;
            }
        }
        
        // ============================================
        // D√âTECTION MOBILE
        // ============================================
        async function detectFrameMobile() {
            if (!isStreaming || isProcessing || !detectionActive) return;
            
            isProcessing = true;
            frameCount++;
            loader.classList.add('active');
            
            try {
                // 1. Capturer frame optimis√©e
                const imageBlob = await captureMobileFrame();
                if (!imageBlob) return;
                
                // 2. Envoyer √† l'API mobile
                const startTime = performance.now();
                const result = await sendMobileDetection(imageBlob);
                const processingTime = performance.now() - startTime;
                
                // 3. Traiter r√©sultats
                if (result && result.success) {
                    processMobileDetections(result, processingTime);
                }
                
                // 4. Mettre √† jour FPS
                updateMobileFPS(processingTime);
                
            } catch (error) {
                console.error("D√©tection error:", error);
                showToast("‚ùå Erreur d√©tection", true);
            } finally {
                isProcessing = false;
                loader.classList.remove('active');
            }
        }
        
        async function captureMobileFrame() {
            if (!isStreaming) return null;
            
            const canvas = document.createElement('canvas');
            
            // Optimisation mobile
            const maxSize = 1024;
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            if (width > maxSize || height > maxSize) {
                const ratio = maxSize / Math.max(width, height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, width, height);
            
            // Qualit√© r√©duite pour mobile
            return new Promise((resolve) => {
                canvas.toBlob(resolve, 'image/jpeg', 0.7);
            });
        }
        
        async function sendMobileDetection(imageBlob) {
            const formData = new FormData();
            formData.append('frame', imageBlob, 'mobile_frame.jpg');
            
            const response = await fetch(`${API_URL}/detect`, {
                method: 'POST',
                body: formData,
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }
        
        // ============================================
        // TRAITEMENT R√âSULTATS MOBILE
        // ============================================
        function processMobileDetections(result, processingTime) {
            const detections = result.detections || [];
            
            // Filtrer par confiance
            const filteredDetections = detections.filter(d => 
                d.confidence >= MOBILE_CONFIG.minConfidence &&
                d.width < overlay.width * MOBILE_CONFIG.maxBoxWidth &&
                d.height < overlay.height * MOBILE_CONFIG.maxBoxHeight
            );
            
            currentDetections = filteredDetections;
            
            // Mettre √† jour l'interface
            updateDetectionsListMobile(filteredDetections);
            drawMobileDetections(filteredDetections);
            
            // Stats
            statsDisplay.textContent = `${filteredDetections.length} d√©tection(s)`;
            
            // Info bulle
            if (filteredDetections.length > 0) {
                const best = filteredDetections[0];
                updateInfoBubble(`üéØ ${best.class_name} ${best.confidence}%`);
            } else {
                updateInfoBubble("üîç Recherche...");
            }
            
            // Log l√©ger
            console.log(`üìä ${filteredDetections.length} d√©tections en ${processingTime.toFixed(0)}ms`);
        }
        
        function updateMobileFPS(processingTime) {
            const now = Date.now();
            const elapsed = now - lastFpsTime;
            
            if (elapsed >= 1000) {
                fps = Math.round((frameCount * 1000) / elapsed);
                fpsDisplay.textContent = fps;
                frameCount = 0;
                lastFpsTime = now;
            }
        }
        
        // ============================================
        // DESSIN MOBILE
        // ============================================
        function drawMobileDetections(detections) {
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            
            if (detections.length === 0) return;
            
            // Style mobile
            const styles = {
                high: { color: '#00ff88', width: 3, opacity: 0.3 },
                medium: { color: '#ffcc00', width: 2, opacity: 0.2 },
                low: { color: '#ff4444', width: 1, opacity: 0.1 }
            };
            
            detections.forEach(det => {
                const box = det.box_pixels || calculateBoxFromNormalized(det.box);
                const [x1, y1, x2, y2] = box;
                
                // Style selon confiance
                let style;
                if (det.confidence >= 80) style = styles.high;
                else if (det.confidence >= 60) style = styles.medium;
                else style = styles.low;
                
                // Dessiner bo√Æte (l√©g√®re pour mobile)
                ctx.strokeStyle = style.color;
                ctx.lineWidth = style.width;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // Overlay l√©ger
                ctx.fillStyle = style.color.replace(')', `, ${style.opacity})`);
                ctx.fillRect(x1, y1, x2 - x1, y2 - y1);
                
                // Label minimaliste
                ctx.fillStyle = style.color;
                const label = `${det.confidence}%`;
                ctx.font = 'bold 14px Arial';
                ctx.fillText(label, x1 + 5, y1 - 8);
            });
        }
        
        function calculateBoxFromNormalized(normalizedBox) {
            if (!normalizedBox || normalizedBox.length !== 4) return [0, 0, 0, 0];
            
            return [
                normalizedBox[0] * overlay.width,
                normalizedBox[1] * overlay.height,
                normalizedBox[2] * overlay.width,
                normalizedBox[3] * overlay.height
            ];
        }
        
        // ============================================
        // INTERFACE MOBILE
        // ============================================
        function updateDetectionsListMobile(detections) {
            detectionsCount.textContent = detections.length;
            
            if (detections.length === 0) {
                detectionsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
                        <div>üîç</div>
                        <div style="margin-top: 10px;">Aucune d√©tection</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            detections.slice(0, 10).forEach(det => {
                const confidenceColor = getMobileConfidenceColor(det.confidence);
                
                html += `
                    <div class="detection-card">
                        <div class="detection-header">
                            <div class="detection-name">${det.class_name}</div>
                            <div class="detection-confidence" style="background: ${confidenceColor}">
                                ${det.confidence}%
                            </div>
                        </div>
                        <div class="detection-details">
                            <span>üìè ${det.width}x${det.height}</span>
                            <span>üìç ${det.box_pixels[0]},${det.box_pixels[1]}</span>
                            ${det.is_note ? '<span>üéµ Note</span>' : ''}
                        </div>
                    </div>
                `;
            });
            
            detectionsList.innerHTML = html;
        }
        
        function getMobileConfidenceColor(confidence) {
            if (confidence >= 90) return '#00ff88';
            if (confidence >= 70) return '#22c55e';
            if (confidence >= 50) return '#f59e0b';
            return '#ef4444';
        }
        
        function updateInfoBubble(message) {
            infoBubble.textContent = message;
            infoBubble.style.display = 'block';
            
            // Cacher apr√®s 3 secondes si pas d'erreur
            if (!message.includes('‚ùå')) {
                setTimeout(() => {
                    infoBubble.style.display = 'none';
                }, 3000);
            }
        }
        
        function showToast(message, isError = false) {
            const now = Date.now();
            if (now - lastToastTime < 2000) return;
            
            lastToastTime = now;
            toast.textContent = message;
            toast.style.background = isError 
                ? 'rgba(239, 68, 68, 0.9)' 
                : 'rgba(0, 0, 0, 0.9)';
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ============================================
        // CONTR√îLES MOBILE
        // ============================================
        function startDetection() {
            if (!isStreaming) {
                showToast("üì∑ Activez d'abord la cam√©ra", true);
                return;
            }
            
            detectionActive = true;
            
            if (detectionInterval) clearInterval(detectionInterval);
            detectionInterval = setInterval(
                detectFrameMobile, 
                MOBILE_CONFIG.detectionInterval
            );
            
            // UI
            btnStart.disabled = true;
            btnStop.disabled = false;
            btnStart.classList.remove('active');
            
            showToast("‚ñ∂Ô∏è D√©tection d√©marr√©e");
        }
        
        function stopDetection() {
            detectionActive = false;
            
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            // UI
            btnStart.disabled = false;
            btnStop.disabled = true;
            
            showToast("‚èπÔ∏è D√©tection arr√™t√©e");
        }
        
        function toggleDrawer() {
            detectionsDrawer.classList.toggle('open');
        }
        
        function setupDemoMode() {
            isStreaming = true;
            overlay.width = 720;
            overlay.height = 1280;
            
            // D√©tection de d√©mo
            drawDemoDetections();
            
            showToast("üì± Mode d√©mo activ√©");
        }
        
        function drawDemoDetections() {
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            
            // Exemple de bo√Æte
            const x = overlay.width * 0.3;
            const y = overlay.height * 0.4;
            const width = overlay.width * 0.4;
            const height = overlay.height * 0.2;
            
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            
            ctx.fillStyle = 'rgba(0, 255, 136, 0.1)';
            ctx.fillRect(x, y, width, height);
            
            ctx.fillStyle = '#00ff88';
            ctx.font = 'bold 18px Arial';
            ctx.fillText('üìù Note 95%', x + 10, y - 10);
        }
        
        // ============================================
        // GESTION TOUCH
        // ============================================
        let touchStartY = 0;
        
        detectionsDrawer.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });
        
        detectionsDrawer.addEventListener('touchmove', (e) => {
            if (!detectionsDrawer.classList.contains('open')) return;
            
            const touchY = e.touches[0].clientY;
            const diff = touchStartY - touchY;
            
            if (diff < -50) { // Swipe down
                detectionsDrawer.classList.remove('open');
            }
        }, { passive: true });
        
        // ============================================
        // D√âMARRAGE
        // ============================================
        window.addEventListener('DOMContentLoaded', initializeMobile);
        
        // Gestion orientation
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                location.reload();
            }, 100);
        });
        
        // Pr√©venir la fermeture
        window.addEventListener('beforeunload', (e) => {
            if (detectionActive) {
                e.preventDefault();
                e.returnValue = 'La d√©tection est en cours. Voulez-vous vraiment quitter?';
            }
        });
    </script>
</body>
</html>
